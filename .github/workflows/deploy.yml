name: Centinel Prod CI

on:
  push:
    branches: [main]

env:
  NODE_ENV: production
  APP_NAME: centinel-prod
  NGINX_CONFIG_PATH: /etc/nginx/sites-enabled/c.r-tech.live
  APP_DOMAIN: c.r-tech.live
  HEALTH_CHECK_END_POINT: /api/v1/health
  DEPLOY_DIRECTORY: '~/deploy/centinel-prod'

  # Primary and secondary ports for zero-downtime deploys
  PRIMARY_PORT: 4601
  SECONDARY_PORT: 4600

  DOCKER_USER: ${{ secrets.DOCKER_HUB_USER }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}

  HOST: ${{ secrets.PROD_HOST_BD }}
  USER: ${{ secrets.PROD_USER_BD }}
  SSH_KEY: ${{ secrets.PROD_SSH_KEY_BD }}

jobs:
  Build:
    # runs-on: self-hosted
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process and Load Environment Variables
        run: |
          # Write secrets directly to production.env (already in KEY=VALUE format)
          echo "${{ secrets.PRODUCTION_ENV_VARS }}" | tr -d '\r' | sed "s/^[[:space:]]*//;s/[[:space:]]*$//;s/ *= */=/" > ./environments/production.env
          echo "✅ Created production.env:"
          cat ./environments/production.env

      - name: Log in to Docker Hub
        run: docker login -u ${{env.DOCKER_USER}} -p ${{env.DOCKER_PASSWORD}}
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag ${{env.DOCKER_USER}}/${{env.APP_NAME}}:latest
      - name: Docker Push
        run: docker push ${{env.DOCKER_USER}}/${{env.APP_NAME}}:latest

      - name: Zero Downtime Deploy to DigitalOcean
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          key: ${{ env.SSH_KEY }}
          script: |
            set -e

            echo "Logging into Docker"
            mkdir -p /tmp/docker-config
            echo '{}' > /tmp/docker-config/config.json
            export DOCKER_CONFIG=/tmp/docker-config
            echo "${{ env.DOCKER_PASSWORD }}" | docker login -u "${{ env.DOCKER_USER }}" --password-stdin

            echo "Pulling latest Docker image"
            docker pull ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:latest

            # Use env-configured primary/secondary ports
            PRIMARY_PORT=${{ env.PRIMARY_PORT }}
            SECONDARY_PORT=${{ env.SECONDARY_PORT }}

            CURRENT_PORT=$(grep -oP '(?<=proxy_pass http://127.0.0.1:)\d+' "${{ env.NGINX_CONFIG_PATH }}" || echo "")

            if [ -z "$CURRENT_PORT" ]; then
              NEW_PORT=$SECONDARY_PORT
              NEW_CONTAINER=${{ env.APP_NAME }}-$SECONDARY_PORT
            elif [ "$CURRENT_PORT" == "$SECONDARY_PORT" ]; then
              NEW_PORT=$PRIMARY_PORT
              OLD_CONTAINER=${{ env.APP_NAME }}-$SECONDARY_PORT
              NEW_CONTAINER=${{ env.APP_NAME }}-$PRIMARY_PORT
            else
              NEW_PORT=$SECONDARY_PORT
              OLD_CONTAINER=${{ env.APP_NAME }}-$PRIMARY_PORT
              NEW_CONTAINER=${{ env.APP_NAME }}-$SECONDARY_PORT
            fi

            echo "Starting new container on port $NEW_PORT"
            docker run -d --name $NEW_CONTAINER \
              -e NODE_ENV=production \
              --restart always \
              -p $NEW_PORT:$SECONDARY_PORT \
              -v /var/www/uploads:/uploads \
              ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:latest || {
                echo "❌ Failed to start container. Cleaning up..."
                docker rmi ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:latest || true
                exit 1
              }

            echo "Waiting for service health on port $NEW_PORT..."
            for i in {1..20}; do
              sleep 5
              if curl -sSf http://localhost:$NEW_PORT${{ env.HEALTH_CHECK_END_POINT }} > /dev/null; then
                echo "✅ Healthy!"
                break
              elif [ $i -eq 20 ]; then
                echo "❌ Health check failed. Removing container and image..."
                docker logs $NEW_CONTAINER || true
                docker rm -f $NEW_CONTAINER || true
                docker rmi ${{ env.DOCKER_USER }}/${{ env.APP_NAME }}:latest || true
                exit 1
              fi
            done

            echo "Updating Nginx to new port $NEW_PORT"
            sed -i "s/proxy_pass http:\/\/127.0.0.1:$CURRENT_PORT;/proxy_pass http:\/\/127.0.0.1:$NEW_PORT;/" "${{ env.NGINX_CONFIG_PATH }}"
            nginx -s reload

            if [ ! -z "$OLD_CONTAINER" ]; then
              echo "Removing old container: $OLD_CONTAINER"
              OLD_IMAGE=$(docker inspect --format='{{.Image}}' $OLD_CONTAINER)
              docker rm -f $OLD_CONTAINER || true
              docker rmi $OLD_IMAGE || true
              docker image prune -f
            fi

            echo "✅ Deployment complete"
